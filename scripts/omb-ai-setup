#!/bin/sh
set -e

SCRIPT_DIR="$HOME/git/omarchy-bootstrap/etc/systemd/system"
HOSTNAME=$(hostname)
PORT=3210

echo "==> [AI] Setting up local AI and Codex"

# --- Opencode ---
if ! command -v opencode >/dev/null 2>&1; then
    echo "[AI] Opencode not found, installing..."
    curl -fsSL https://opencode.ai/install | bash || true
else
    echo "[AI] Opencode is already installed."
fi

# --- Codex ---
if ! command -v codex >/dev/null 2>&1; then
    echo "[AI] Codex not found, installing..."
    npm i -g @openai/codex || true
else
    echo "[AI] Codex is already installed."
fi

# --- Ollama ---
if ! command -v ollama >/dev/null 2>&1; then
    echo "[AI] Ollama not found, installing..."
    curl -fsSL https://ollama.com/install.sh | sh
else
    echo "[AI] Ollama is already installed."
fi

sudo systemctl enable --now ollama

# --- Models ---
echo "[AI] Installing DeepSeek R1 14B..."
ollama pull deepseek-r1:14b
echo "[AI] Installing DeepSeek R1 7B..."
ollama pull deepseek-r1:7b
echo "[AI] Installing Qwen 2.5 Coder 3B..."
ollama pull qwen2.5-coder:3b
echo "[AI] Installing Qwen 2.5 Coder 7B..."
ollama pull qwen2.5-coder:7b
echo "[AI] Installing Qwen 2.5 Coder 14B..."
ollama pull qwen2.5-coder:14b
echo "[AI] Installing Qwen 3 14B..."
ollama pull qwen3:14b
echo "[AI] Installing Qwen 3 8B..."
ollama pull qwen3:8b
echo "[AI] Installing Llama 3.1 8B..."
ollama pull llama3.1:8b
echo "[AI] Installing GPT-OSS 20B..."
ollama pull gpt-oss:20b

# --- Clean old open-webui run ---
docker rm -f open-webui >/dev/null 2>&1 || true
sudo systemctl disable --now openwebui 2>/dev/null || true
sudo rm -f /etc/systemd/system/openwebui.service

echo "[AI] Pulling correct OpenWebUI image"
if [ "$HOSTNAME" = "archtop" ]; then
    docker pull ghcr.io/open-webui/open-webui:cuda
    TEMPLATE="$SCRIPT_DIR/openwebui-archtop.service"
    sudo pacman -S nvidia-container-toolkit --noconfirm
    sudo nvidia-ctk runtime configure --runtime=docker
    sudo systemctl restart docker
elif [ "$HOSTNAME" = "archbook" ]; then
    docker pull ghcr.io/open-webui/open-webui:main
    TEMPLATE="$SCRIPT_DIR/openwebui-archbook.service"
else
    echo "[AI] Unknown hostname: $HOSTNAME"
    exit 1
fi

# --- Validate template exists ---
if [ ! -f "$TEMPLATE" ]; then
    echo "[AI] ERROR: Template not found: $TEMPLATE"
    exit 1
fi

echo "[AI] Copying $(basename \"$TEMPLATE\")"
sudo cp "$TEMPLATE" /etc/systemd/system/openwebui.service

sudo systemctl daemon-reload
sudo systemctl enable --now openwebui

echo "[AI] Done. OpenWebUI will run at: http://localhost:$PORT"
